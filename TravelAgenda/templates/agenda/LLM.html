{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1 class="mt-4">根据目的地生成旅游日程规划</h1>
    <form id="itineraryForm">
        {% csrf_token %}
        <div class="mb-3">
            <label for="destination" class="form-label">目的地</label>
            <input type="text" class="form-control" id="destination" name="destination" placeholder="输入目的地" required>
        </div>
        <div class="mb-3">
            <label for="days" class="form-label">天数</label>
            <input type="number" class="form-control" id="days" name="days" placeholder="输入旅行天数" required>
        </div>
        <button type="submit" class="btn btn-primary">生成日程</button>
    </form>
    
    <div id="itineraryResult" class="mt-5" style="display: none;">
        <h2>您的旅游日程</h2>
        <ul id="itineraryList" class="list-group"></ul>
    </div>
</div>

<script>
    document.getElementById('itineraryForm').addEventListener('submit', async function(event) {
        event.preventDefault(); // 防止表单默认提交

        const destination = document.getElementById('destination').value;
        const days = document.getElementById('days').value;

        // API 请求数据
        const requestBody = {
            "model": "spark-max",
            "messages": [
                {
                    "role": "user",
                    "content": `请为我生成一个为期 ${days} 天的 ${destination} 旅游日程。`
                }
            ]
        };

        try {
            const response = await fetch('https://spark-api-open.xf-yun.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer PzfmyIDmgfUOEZGdLmNB:ZfmpxbVMijaJThZaVWeQ',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error('网络响应不正常');
            }

            const data = await response.json();
            const itinerary = data.choices[0].message.content;

            // 显示结果
            document.getElementById('itineraryList').innerHTML = itinerary.split('\n').map(item => `<li class="list-group-item">${item}</li>`).join('');
            document.getElementById('itineraryResult').style.display = 'block';
        } catch (error) {
            console.error('发生错误:', error);
            alert(`生成日程时出错：${error.message}`);
        }
    });
</script>
{% endblock %}